<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Sala</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" th:href="@{/css/tailwind.css}" href="/css/tailwind.css" />
  </head>
  <body
    th:attr="data-room-id=${room.id},data-base=@{/}"
    class="min-h-screen bg-gradient-to-br from-amber-50 via-rose-50 to-indigo-50 text-gray-900"
  >
    <div class="max-w-5xl mx-auto p-4 space-y-6">
      <header
        class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
      >
        <div>
          <h1 class="text-3xl font-bold">Sala</h1>
          <p class="text-sm text-gray-600">Control de la partida en vivo</p>
        </div>
        <a
          class="inline-flex self-start rounded-full bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-blue-700 sm:self-auto"
          th:href="@{/rooms}"
          >Volver a mis salas</a
        >
      </header>

      <section
        class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6 space-y-3"
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <p><b>PIN:</b> <span th:text="${room.pin}"></span></p>
          <p><b>Bloque:</b> <span th:text="${room.block.name}"></span></p>
          <p>
            <b>Número de preguntas:</b>
            <span th:text="${room.questionCount}"></span>
          </p>
          <p>
            <b>Tiempo por pregunta:</b>
            <span th:text="${room.timePerQuestion}"></span> s
          </p>
          <p>
            <b>Estado:</b>
            <span
              id="room-state"
              th:text="${room.state.name() == 'WAITING' ? 'ESPERANDO' : (room.state.name() == 'RUNNING' ? 'EN JUEGO' : 'FINALIZADA')}"
            ></span>
          </p>
        </div>
      </section>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <details
          class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6"
          open
        >
          <summary class="font-semibold cursor-pointer">Jugadores</summary>
          <div class="mt-3">
            <p
              id="players-empty"
              class="text-gray-600"
              th:classappend="${#lists.isEmpty(players)} ? '' : ' hidden'"
            >
              Nadie conectado todavía.
            </p>
            <ul
              id="players-list"
              class="space-y-1"
              th:classappend="${!#lists.isEmpty(players)} ? '' : ' hidden'"
            >
              <li th:each="p : ${players}" class="flex items-center gap-2">
                <span
                  class="inline-block w-2 h-2 rounded-full bg-white border"
                  th:classappend="${p.status == 'finished'} ? ' bg-gray-900 border-gray-900' : (${p.status == 'correct'} ? ' bg-green-600 border-green-600' : (${p.status == 'wrong'} ? ' bg-red-600 border-red-600' : (${p.status == 'inactive'} ? ' bg-gray-400 border-gray-400' : '')))"
                ></span>
                <span
                  th:text="${p.name}"
                  th:classappend="${p.status == 'inactive'} ? ' line-through text-gray-500' : ''"
                ></span>
              </li>
            </ul>
          </div>
        </details>

        <details
          id="ranking-section"
          class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6"
          th:classappend="${room.state.name() != 'WAITING'} ? '' : ' hidden'"
          open
        >
          <summary class="font-semibold cursor-pointer">Clasificación</summary>
          <div class="mt-3">
            <p
              id="ranking-empty"
              th:classappend="${#lists.isEmpty(ranking)} ? '' : ' hidden'"
            >
              Aún no hay resultados.
            </p>
            <table
              id="ranking-table"
              class="w-full text-sm"
              th:classappend="${!#lists.isEmpty(ranking)} ? '' : ' hidden'"
            >
              <thead>
                <tr>
                  <th class="text-left">Jugador</th>
                  <th class="text-right">Puntos</th>
                </tr>
              </thead>
              <tbody id="ranking-body">
                <tr th:each="p : ${ranking}">
                  <td th:text="${p.name}"></td>
                  <td class="text-right" th:text="${p.score}"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </details>

        <details
          id="current-question-section"
          class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6"
          th:if="${room.state.name() == 'RUNNING'}"
          open
        >
          <summary class="font-semibold cursor-pointer">
            Pregunta actual (anfitrión)
          </summary>
          <div class="mt-3 space-y-1">
            <p>
              <b>Tiempo restante:</b>
              <span id="question-timer">--</span> s
            </p>
            <p>
              <b>Enunciado:</b>
              <span
                id="current-question"
                th:text="${currentQuestion != null ? currentQuestion.statement : '-'}"
              ></span>
            </p>
            <p>
              <b>Correcta:</b>
              <span
                id="current-answer"
                th:text="${currentQuestion != null ? currentQuestion.correctOption : '-'}"
              ></span>
            </p>
          </div>
        </details>

        <details
          class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6"
        >
          <summary class="font-semibold cursor-pointer">
            Selección de preguntas
          </summary>
          <div class="mt-3">
            <p th:if="${hasSelection == null || !hasSelection}">
              Aún no hay selección de preguntas.
              <a
                class="text-blue-600 hover:underline"
                th:if="${room.selectionMode.name() == 'MANUAL'}"
                th:href="@{/rooms/{id}/select(id=${room.id})}"
                >Seleccionar ahora</a
              >
            </p>
            <div th:if="${hasSelection != null && hasSelection}">
              <ol class="list-decimal pl-5 space-y-1">
                <li
                  th:each="rq : ${selection}"
                  th:text="${rq.question.statement}"
                ></li>
              </ol>
            </div>
          </div>
        </details>
      </div>

      <section
        class="rounded-3xl bg-white/90 shadow-xl ring-1 ring-rose-100 backdrop-blur p-5 sm:p-6 space-y-3"
      >
        <p class="text-red-600 font-semibold" th:if="${param.error}" th:text="${param.error}"></p>
        <div class="flex flex-col gap-2">
          <p>Comparte el PIN con los jugadores para que se unan.</p>
          <div
            id="start-section"
            th:if="${room.state.name() == 'WAITING'}"
            class="text-sm text-gray-600"
          >
            Esta sala se borrara automaticamente en:
            <b id="countdown">--:--</b>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-end items-center">
          <form
            id="start-form"
            class="inline-flex"
            th:if="${room.state.name() == 'WAITING'}"
            method="post"
            th:action="@{/rooms/{id}/start(id=${room.id})}"
          >
            <button
              id="btn-start"
              class="px-3 py-2 bg-blue-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
              th:disabled="${#lists.isEmpty(players)}"
              type="submit"
            >
              Iniciar partida
            </button>
          </form>

          <div
            id="running-section"
            th:if="${room.state.name() == 'RUNNING' and room.advanceMode != null and room.advanceMode.name() == 'MANUAL'}"
            class="flex flex-wrap gap-2 items-center"
          >
            <form
              id="btn-show-results"
              class="inline-flex"
              method="post"
              th:action="@{/rooms/{id}/next(id=${room.id})}"
            >
              <button
                class="px-3 py-2 bg-gray-800 text-white rounded"
                type="submit"
              >
                Mostrar resultados
              </button>
            </form>
            <form
              id="btn-force-results"
              class="inline-flex"
              method="post"
              th:action="@{/rooms/{id}/force(id=${room.id})}"
            >
              <button
                class="px-3 py-2 bg-yellow-500 text-white rounded"
                type="submit"
              >
                Forzar resultados
              </button>
            </form>
            <form
              id="btn-next-question"
              class="inline-flex"
              method="post"
              th:action="@{/rooms/{id}/next(id=${room.id})}"
            >
              <button
                class="px-3 py-2 bg-gray-800 text-white rounded"
                type="submit"
              >
                Siguiente pregunta
              </button>
            </form>
            <form
              class="inline-flex"
              method="post"
              th:action="@{/rooms/{id}/stop(id=${room.id})}"
            >
              <button
                class="px-3 py-2 bg-red-600 text-white rounded"
                type="submit"
              >
                Cerrar sala
              </button>
            </form>
          </div>
        </div>
      </section>
    </div>

    <script th:src="@{/js/lobby.js}" src="/js/lobby.js"></script>
  </body>
</html>
